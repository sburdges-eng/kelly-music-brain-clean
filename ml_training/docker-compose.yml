# MidiKompanion ML Training Docker Compose Configuration
#
# Usage:
#   docker-compose up training          # Train all models
#   docker-compose up data-processing   # Process datasets
#   docker-compose run --rm validate    # Validate models

version: '3.8'

services:
  # Main training service
  training:
    build:
      context: .
      dockerfile: Dockerfile
    image: midikompanion-ml-training
    container_name: midikompanion-training
    volumes:
      - ./models:/workspace/models
      - ./data:/workspace/data
      - ./logs:/workspace/logs
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - PYTHONUNBUFFERED=1
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    command: >
      python train_all_models.py
      --epochs 100
      --batch-size 32
      --learning-rate 0.001
      --output-dir /workspace/models

  # Data processing service (no GPU needed)
  data-processing:
    build:
      context: .
      dockerfile: Dockerfile.data
    image: midikompanion-data-processing
    container_name: midikompanion-data
    volumes:
      - ./data:/workspace/data
      - ./raw_data:/workspace/raw_data
    command: python prepare_datasets.py --input /workspace/raw_data --output /workspace/data

  # Validation service
  validate:
    build:
      context: .
      dockerfile: Dockerfile
    image: midikompanion-ml-training
    volumes:
      - ./models:/workspace/models
    command: python validate_models.py --models-dir /workspace/models

  # TensorBoard for monitoring
  tensorboard:
    image: tensorflow/tensorflow:2.15.0
    container_name: midikompanion-tensorboard
    volumes:
      - ./logs:/logs
    ports:
      - "6006:6006"
    command: tensorboard --logdir=/logs --host=0.0.0.0

networks:
  default:
    name: midikompanion-ml-network
